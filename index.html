<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Hehebank v3.7: Enhanced Edition</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root { 
    --bg: #020617; 
    --card: #1e293b; 
    --accent: #10b981; 
    --danger: #ef4444; 
    --text: #f8fafc; 
    --gold: #f59e0b; 
    --blue: #3b82f6; 
    --pink: #ec4899; 
}

* { box-sizing: border-box; }

body { 
    margin: 0; 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    background: var(--bg); 
    color: var(--text); 
    padding: 8px; 
    overflow-x: hidden; 
    -webkit-tap-highlight-color: transparent;
}

.card { 
    background: var(--card); 
    border-radius: 14px; 
    padding: 15px; 
    margin-bottom: 10px; 
    border: 1px solid #334155; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

input, button, select { 
    width: 100%; 
    padding: 12px; 
    margin-top: 6px; 
    border-radius: 10px; 
    border: none; 
    font-size: 14px; 
    font-family: inherit;
}

input, select {
    background: #0f172a;
    color: var(--text);
    border: 1px solid #334155;
}

input:focus, select:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

button { 
    background: var(--accent); 
    color: white; 
    font-weight: bold; 
    cursor: pointer; 
    border-bottom: 3px solid rgba(0,0,0,0.2);
    transition: all 0.15s ease;
}

button:active { 
    transform: translateY(2px); 
    border-bottom: 1px solid rgba(0,0,0,0.2);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.secondary { background: #475569; }
.danger { background: var(--danger); }
.gold-btn { background: var(--gold); color: #000; }
.blue-btn { background: var(--blue); }
.pink-btn { background: var(--pink); }

.balance { 
    font-size: 32px; 
    font-weight: 800; 
    color: var(--accent); 
    text-align: center; 
    margin: 10px 0; 
    text-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.small { 
    color: #94a3b8; 
    font-size: 11px; 
    text-transform: uppercase; 
    font-weight: bold; 
    letter-spacing: 0.5px;
}

.hidden { display: none !important; }

.grid-2 { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 8px; 
}

.scroll-x { 
    display: flex; 
    overflow-x: auto; 
    gap: 8px; 
    padding-bottom: 10px; 
    scrollbar-width: thin;
    scrollbar-color: #334155 #0f172a;
}

.scroll-x::-webkit-scrollbar {
    height: 6px;
}

.scroll-x::-webkit-scrollbar-track {
    background: #0f172a;
    border-radius: 3px;
}

.scroll-x::-webkit-scrollbar-thumb {
    background: #334155;
    border-radius: 3px;
}

.mini-card { 
    flex: 0 0 140px; 
    background: #0f172a; 
    padding: 12px; 
    border-radius: 10px; 
    text-align: center; 
    border: 1px solid #334155;
}

.mini-card button {
    margin-top: 8px;
    padding: 8px;
    font-size: 12px;
}

.history { 
    max-height: 150px; 
    overflow-y: auto; 
    font-size: 12px; 
    list-style: none; 
    padding: 0; 
    margin: 10px 0 0 0;
}

.history li { 
    padding: 8px; 
    border-bottom: 1px solid #1e293b;
    background: #0f172a;
    margin-bottom: 4px;
    border-radius: 6px;
}

.nav { 
    display: flex; 
    justify-content: space-around; 
    background: #0f172a; 
    padding: 12px; 
    position: fixed; 
    bottom: 0; 
    left: 0; 
    right: 0; 
    border-top: 2px solid #334155; 
    z-index: 100;
    box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
}

.nav-item { 
    font-size: 26px; 
    cursor: pointer; 
    filter: grayscale(1) opacity(0.6); 
    transition: all 0.3s ease;
    padding: 8px;
}

.nav-item:hover {
    filter: grayscale(0.5) opacity(0.8);
}

.nav-item.active { 
    filter: grayscale(0) opacity(1); 
    transform: scale(1.2); 
}

#p-admin { border: 2px solid var(--gold); }

.biz-count {
    display: inline-block;
    background: var(--accent);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    margin-top: 4px;
    font-weight: bold;
}

.stock-info {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    padding: 8px;
    background: #0f172a;
    border-radius: 8px;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.loading {
    animation: pulse 1.5s ease-in-out infinite;
}
</style>
</head>
<body>

<div id="auth" class="card" style="margin-top: 50px;">
    <h1 style="text-align: center; margin: 0 0 20px 0;">üè¶ HEHEBANK <span style="color:var(--gold)">v3.7</span></h1>
    <input id="loginField" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
    <input id="passwordField" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button onclick="loginUser()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
    <button class="secondary" onclick="registerUser()">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
</div>

<div id="bank" class="hidden" style="padding-bottom: 80px;">
    <div id="p-main" class="p-page">
        <div class="card">
            <div id="uInfo" class="grid-2">
                <span>LVL: 1</span>
                <span style="text-align:right">EXP: 0/100</span>
            </div>
            <div class="balance"><span id="balance">0</span> $</div>
            <button style="height: 100px; font-size: 24px; border-radius: 20px; margin-top: 10px;" onclick="clickMoney()">
                üí∞ –¢–ê–ü–ê–¢–¨ (+$10)
            </button>
        </div>

        <div class="card">
            <div class="small">üèõÔ∏è –ü–ê–°–°–ò–í–ù–´–ô –ë–ò–ó–ù–ï–°</div>
            <div class="scroll-x" style="margin-top: 10px;">
                <div class="mini-card">
                    <div style="font-size: 32px;">‚òï</div>
                    <div style="margin: 8px 0; font-weight: bold;">–õ–∞—Ä—ë–∫</div>
                    <small style="color: var(--accent);">+$5 –∫–∞–∂–¥—ã–µ 5—Å</small>
                    <div id="biz-stall-count" class="biz-count hidden">0</div>
                    <button class="gold-btn" onclick="buyBiz('stall', 1000)">$1,000</button>
                </div>
                <div class="mini-card">
                    <div style="font-size: 32px;">üöó</div>
                    <div style="margin: 8px 0; font-weight: bold;">–ú–æ–π–∫–∞</div>
                    <small style="color: var(--accent);">+$50 –∫–∞–∂–¥—ã–µ 5—Å</small>
                    <div id="biz-wash-count" class="biz-count hidden">0</div>
                    <button class="gold-btn" onclick="buyBiz('wash', 10000)">$10,000</button>
                </div>
                <div class="mini-card">
                    <div style="font-size: 32px;">üè¢</div>
                    <div style="margin: 8px 0; font-weight: bold;">–ó–∞–≤–æ–¥</div>
                    <small style="color: var(--accent);">+$500 –∫–∞–∂–¥—ã–µ 5—Å</small>
                    <div id="biz-factory-count" class="biz-count hidden">0</div>
                    <button class="gold-btn" onclick="buyBiz('factory', 100000)">$100,000</button>
                </div>
                <div class="mini-card">
                    <div style="font-size: 32px;">üöÄ</div>
                    <div style="margin: 8px 0; font-weight: bold;">SpaceX</div>
                    <small style="color: var(--accent);">+$5k –∫–∞–∂–¥—ã–µ 5—Å</small>
                    <div id="biz-space-count" class="biz-count hidden">0</div>
                    <button class="gold-btn" onclick="buyBiz('space', 1000000)">$1.0M</button>
                </div>
            </div>
        </div>
    </div>

    <div id="p-market" class="p-page hidden">
        <div class="card">
            <div class="small">üìà –§–û–ù–î–û–í–´–ô –†–´–ù–û–ö</div>
            <select id="stockSelector" onchange="updateChartDisplay()" style="margin-top: 10px;">
                <option value="mapple">Mapple üçé</option>
                <option value="mycrohard">Mycrohard üñ•Ô∏è</option>
                <option value="colacoko">ColaCoko ü•§</option>
            </select>
            <div class="stock-info">
                <div>
                    <div class="small">–¶–µ–Ω–∞ –∞–∫—Ü–∏–∏</div>
                    <div id="stockPrice" style="font-size: 20px; font-weight: bold; color: var(--accent);">$0</div>
                </div>
                <div style="text-align: right;">
                    <div class="small">–£ –≤–∞—Å –∞–∫—Ü–∏–π</div>
                    <div id="stockOwned" style="font-size: 20px; font-weight: bold;">0</div>
                </div>
            </div>
            <canvas id="stockChart" style="height: 150px; margin: 10px 0;"></canvas>
            <div class="grid-2">
                <button onclick="trade('buyAll')">–ö–£–ü–ò–¢–¨ MAX</button>
                <button class="danger" onclick="trade('sellAll')">–ü–†–û–î–ê–¢–¨ –í–°–Å</button>
            </div>
        </div>
        
        <div class="card" style="border: 2px solid var(--gold);">
            <div class="small" style="color:var(--gold)">‚Çø –ö–†–ò–ü–¢–û–í–ê–õ–Æ–¢–ê (HEHECOIN)</div>
            <div style="font-size: 28px; text-align: center; margin: 15px 0; font-weight: bold;">
                ‚Çø <span id="cryptoPriceDisplay">0</span>
            </div>
            <div style="text-align: center; margin-bottom: 10px;">
                <span class="small">–£ –≤–∞—Å:</span> 
                <span id="cryptoOwned" style="font-size: 18px; font-weight: bold; color: var(--gold);">0 ‚Çø</span>
            </div>
            <div class="grid-2">
                <button class="gold-btn" onclick="cryptoOp('buy')">–ö–£–ü–ò–¢–¨ 1 ‚Çø</button>
                <button class="danger" onclick="cryptoOp('sell')">–ü–†–û–î–ê–¢–¨ 1 ‚Çø</button>
            </div>
        </div>
    </div>

    <div id="p-casino" class="p-page hidden">
        <div class="card">
            <h3 style="text-align: center; margin: 0 0 15px 0;">üé∞ –ö–ê–ó–ò–ù–û</h3>
            <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: #0f172a; border-radius: 8px;">
                <span class="small">–°—Ç–∞–≤–∫–∞ –Ω–∞ –∏–≥—Ä—É</span><br>
                <span style="font-size: 24px; font-weight: bold; color: var(--gold);">$500</span>
            </div>
            <button class="blue-btn" onclick="game('dice')">üé≤ –ö–û–°–¢–ò (x2.0 - 50% —à–∞–Ω—Å)</button>
            <button class="pink-btn" style="margin-top: 10px;" onclick="game('coin')">ü™ô –ú–û–ù–ï–¢–ö–ê (x1.5 - 60% —à–∞–Ω—Å)</button>
            <button class="gold-btn" style="margin-top: 10px;" onclick="game('slots')">üé∞ –°–õ–û–¢–´ (x50 - 2% —à–∞–Ω—Å)</button>
        </div>
        
        <div class="card">
            <div class="small">üèÜ –¢–û–ü-5 –ò–ì–†–û–ö–û–í</div>
            <div id="leaderboard" style="padding: 10px 0;"></div>
        </div>
    </div>

    <div id="p-admin" class="p-page hidden">
        <div class="card" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);">
            <div class="small" style="color:var(--gold); font-size: 14px;">üëë –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</div>
            <input id="adm_target" placeholder="–õ–æ–≥–∏–Ω –∏–≥—Ä–æ–∫–∞">
            <input id="adm_val" type="number" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
            <div class="grid-2">
                <button onclick="ovl('money')">üíµ –í–´–î–ê–¢–¨ $</button>
                <button class="danger" onclick="ovl('ban')">üö´ –ë–ê–ù</button>
                <button class="gold-btn" onclick="ovl('pump')">üìà PUMP x2</button>
                <button class="danger" onclick="ovl('dump')">üìâ DUMP 0.5</button>
            </div>
            <button class="secondary" style="margin-top:8px" onclick="ovl('msg')">üì¢ –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï</button>
        </div>
    </div>

    <div class="card">
        <div class="small">üìú –ò–°–¢–û–†–ò–Ø –û–ü–ï–†–ê–¶–ò–ô</div>
        <ul id="historyList" class="history"></ul>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="nav('p-main', this)" title="–ì–ª–∞–≤–Ω–∞—è">üè†</div>
    <div class="nav-item" onclick="nav('p-market', this)" title="–ë–∏—Ä–∂–∞">üìà</div>
    <div class="nav-item" onclick="nav('p-casino', this)" title="–ö–∞–∑–∏–Ω–æ">üé∞</div>
    <div id="adm-nav" class="nav-item hidden" onclick="nav('p-admin', this)" title="–ê–¥–º–∏–Ω–∫–∞">‚öôÔ∏è</div>
    <div class="nav-item" onclick="logout()" title="–í—ã—Ö–æ–¥">üö™</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyAJtR-ua4GFV7CNwrpeQZLm4W7MuIVjdlE",
    databaseURL: "https://hehebank-2a84f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hehebank-2a84f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let current = null;
let prices = {mapple: 100, mycrohard: 150, colacoko: 50, crypto: 5000};
let chartData = {mapple: [], mycrohard: [], colacoko: []};
let userData = null;

// --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
function nav(id, el) {
    document.querySelectorAll('.p-page').forEach(p => p.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    if(id === 'p-market') {
        updateStockInfo();
    }
}

// --- –°–ò–°–¢–ï–ú–ê –ò–ì–†–û–ö–ê ---
async function loginUser() {
    const l = document.getElementById('loginField').value.trim().toLowerCase();
    const p = document.getElementById('passwordField').value;
    
    if(!l || !p) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        return;
    }
    
    try {
        const s = await db.ref('users/' + l).once('value');
        if(!s.exists() || s.val().password !== p) {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
            return;
        }
        if(s.val().isBanned) {
            alert("–í–´ –ó–ê–ë–ê–ù–ï–ù–´");
            return;
        }
        
        current = l;
        document.getElementById('auth').classList.add("hidden");
        document.getElementById('bank').classList.remove("hidden");
        
        if(current === 'admin') {
            document.getElementById('adm-nav').classList.remove('hidden');
        }
        
        db.ref('users/' + current).on('value', snap => {
            userData = snap.val();
            render(userData);
        });
        
        loadLeaderboard();
        updateChartDisplay();
    } catch(e) {
        alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
    }
}

async function registerUser() {
    const l = document.getElementById('loginField').value.trim().toLowerCase();
    const p = document.getElementById('passwordField').value;
    
    if(l.length < 3) {
        alert("–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞");
        return;
    }
    
    if(p.length < 4) {
        alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞");
        return;
    }
    
    try {
        const s = await db.ref('users/' + l).once('value');
        if(s.exists()) {
            alert("–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç");
            return;
        }
        
        await db.ref('users/' + l).set({
            password: p,
            balance: 1000,
            exp: 0,
            lvl: 1,
            biz: {stall: 0, wash: 0, factory: 0, space: 0},
            stocks: {
                mapple: {q: 0},
                mycrohard: {q: 0},
                colacoko: {q: 0}
            },
            crypto: 0,
            history: [`–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω ${new Date().toLocaleString('ru')}`]
        });
        
        alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
        document.getElementById('passwordField').value = '';
    } catch(e) {
        alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + e.message);
    }
}

function render(d) {
    if(!d) return;
    
    document.getElementById('balance').textContent = Math.floor(d.balance).toLocaleString('ru');
    document.getElementById('uInfo').innerHTML = `<span>LVL: ${d.lvl || 1}</span><span style="text-align:right">EXP: ${d.exp || 0}/${(d.lvl || 1) * 100}</span>`;
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∏–∑–Ω–µ—Å–æ–≤
    ['stall', 'wash', 'factory', 'space'].forEach(biz => {
        const el = document.getElementById(`biz-${biz}-count`);
        if(d.biz && d.biz[biz] > 0) {
            el.textContent = d.biz[biz];
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    });
    
    // –ò—Å—Ç–æ—Ä–∏—è
    const hl = document.getElementById('historyList');
    hl.innerHTML = "";
    if(d.history && d.history.length > 0) {
        const historyArray = Array.isArray(d.history) ? d.history : Object.values(d.history);
        historyArray.slice(-15).reverse().forEach(h => {
            const li = document.createElement("li");
            li.textContent = h;
            hl.appendChild(li);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∏–ø—Ç—ã
    if(document.getElementById('cryptoOwned')) {
        document.getElementById('cryptoOwned').textContent = (d.crypto || 0);
    }
    
    updateStockInfo();
}

function clickMoney() {
    db.ref('users/' + current).transaction(u => {
        if(u) {
            u.balance += 10;
            u.exp += 5;
            if(u.exp >= u.lvl * 100) {
                u.exp = 0;
                u.lvl += 1;
                u.history = u.history || [];
                u.history.push(`üéä –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù –î–û ${u.lvl} | ${new Date().toLocaleTimeString('ru')}`);
            }
        }
        return u;
    });
}

// --- –ë–ò–ó–ù–ï–° ---
async function buyBiz(id, cost) {
    if(!current) return;
    
    db.ref('users/' + current).transaction(u => {
        if(u) {
            if(u.balance >= cost) {
                u.balance -= cost;
                u.biz = u.biz || {};
                u.biz[id] = (u.biz[id] || 0) + 1;
                u.history = u.history || [];
                u.history.push(`‚úÖ –ö—É–ø–ª–µ–Ω –±–∏–∑–Ω–µ—Å: ${id.toUpperCase()} | ${new Date().toLocaleTimeString('ru')}`);
            } else {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
            }
        }
        return u;
    });
}

// –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
setInterval(() => {
    if(current) {
        db.ref('users/' + current).transaction(u => {
            if(u && u.biz) {
                let income = (u.biz.stall || 0) * 5 + 
                             (u.biz.wash || 0) * 50 + 
                             (u.biz.factory || 0) * 500 + 
                             (u.biz.space || 0) * 5000;
                if(income > 0) {
                    u.balance += income;
                }
            }
            return u;
        });
    }
}, 5000);

// --- –ë–ò–†–ñ–ê ---
db.ref('market').on('value', snap => {
    const d = snap.val();
    if(!d) {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä—ã–Ω–∫–∞
        db.ref('market').set({
            mapple: 100,
            mycrohard: 150,
            colacoko: 50,
            crypto: 5000
        });
        return;
    }
    prices = d;
    document.getElementById('cryptoPriceDisplay').textContent = "$" + Math.floor(d.crypto).toLocaleString('ru');
    updateChartDisplay();
    updateStockInfo();
});

function updateStockInfo() {
    if(!userData) return;
    const s = document.getElementById('stockSelector').value;
    document.getElementById('stockPrice').textContent = "$" + Math.floor(prices[s]).toLocaleString('ru');
    document.getElementById('stockOwned').textContent = (userData.stocks && userData.stocks[s] ? userData.stocks[s].q : 0);
}

async function trade(type) {
    const s = document.getElementById('stockSelector').value;
    
    db.ref('users/' + current).transaction(u => {
        if(u) {
            u.stocks = u.stocks || {mapple: {q: 0}, mycrohard: {q: 0}, colacoko: {q: 0}};
            
            if(type === 'buyAll') {
                let q = Math.floor(u.balance / prices[s]);
                if(q > 0) {
                    const cost = q * prices[s];
                    u.stocks[s].q = (u.stocks[s].q || 0) + q;
                    u.balance -= cost;
                    u.history = u.history || [];
                    u.history.push(`üìà –ö—É–ø–ª–µ–Ω–æ ${q} –∞–∫—Ü–∏–π ${s.toUpperCase()} –∑–∞ $${Math.floor(cost).toLocaleString('ru')}`);
                } else {
                    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                }
            } else if(type === 'sellAll') {
                const owned = u.stocks[s].q || 0;
                if(owned > 0) {
                    const profit = owned * prices[s];
                    u.balance += profit;
                    u.stocks[s].q = 0;
                    u.history = u.history || [];
                    u.history.push(`üìâ –ü—Ä–æ–¥–∞–Ω–æ ${owned} –∞–∫—Ü–∏–π ${s.toUpperCase()} –∑–∞ $${Math.floor(profit).toLocaleString('ru')}`);
                } else {
                    alert("–£ –≤–∞—Å –Ω–µ—Ç —ç—Ç–∏—Ö –∞–∫—Ü–∏–π!");
                }
            }
        }
        return u;
    });
}

// --- –ö–†–ò–ü–¢–ê ---
async function cryptoOp(type) {
    db.ref('users/' + current).transaction(u => {
        if(u) {
            if(type === 'buy' && u.balance >= prices.crypto) {
                u.balance -= prices.crypto;
                u.crypto = (u.crypto || 0) + 1;
                u.history = u.history || [];
                u.history.push(`‚Çø –ö—É–ø–ª–µ–Ω 1 HEHECOIN –∑–∞ $${Math.floor(prices.crypto).toLocaleString('ru')}`);
            } else if(type === 'sell' && (u.crypto || 0) >= 1) {
                u.balance += prices.crypto;
                u.crypto -= 1;
                u.history = u.history || [];
                u.history.push(`‚Çø –ü—Ä–æ–¥–∞–Ω 1 HEHECOIN –∑–∞ $${Math.floor(prices.crypto).toLocaleString('ru')}`);
            } else {
                alert(type === 'buy' ? "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!" : "–£ –≤–∞—Å –Ω–µ—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã!");
            }
        }
        return u;
    });
}

// --- –ö–ê–ó–ò–ù–û ---
async function game(type) {
    const BET = 500;
    
    db.ref('users/' + current).transaction(u => {
        if(u) {
            if(u.balance < BET) {
                alert(`–î–ª—è –∏–≥—Ä—ã –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º $${BET}!`);
                return u;
            }
            
            u.balance -= BET;
            u.history = u.history || [];
            
            const rand = Math.random();
            let won = false;
            let prize = 0;
            
            if(type === 'dice' && rand > 0.5) {
                won = true;
                prize = 1000;
                u.balance += prize;
                u.history.push(`üé≤ –í–´–ò–ì–†–´–® –í –ö–û–°–¢–ò: $${prize}`);
            } else if(type === 'coin' && rand > 0.4) {
                won = true;
                prize = 750;
                u.balance += prize;
                u.history.push(`ü™ô –í–´–ò–ì–†–´–® –í –ú–û–ù–ï–¢–ö–£: $${prize}`);
            } else if(type === 'slots' && rand > 0.98) {
                won = true;
                prize = 25000;
                u.balance += prize;
                u.history.push(`üé∞ –î–ñ–ï–ö–ü–û–¢ –í –°–õ–û–¢–ê–•: $${prize}!!!`);
            }
            
            if(!won) {
                u.history.push(`‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à –≤ –∫–∞–∑–∏–Ω–æ (-$${BET})`);
            }
        }
        return u;
    });
}

// --- –õ–ò–î–ï–†–ë–û–†–î ---
function loadLeaderboard() {
    db.ref('users').orderByChild('balance').limitToLast(5).on('value', s => {
        let html = "";
        let arr = [];
        s.forEach(u => {
            if(!u.val().isBanned) {
                arr.push({name: u.key, bal: u.val().balance});
            }
        });
        arr.reverse().forEach((it, i) => {
            const medal = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "üèÖ";
            html += `<div style="padding: 8px; background: #0f172a; margin: 4px 0; border-radius: 6px;">
                ${medal} ${i +1}. <strong>${it.name.toUpperCase()}</strong> ‚Äî $${Math.floor(it.bal).toLocaleString('ru')}
            </div>`;
        });
        document.getElementById('leaderboard').innerHTML = html || '<div style="padding: 10px; text-align: center; color: #64748b;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    });
}

// --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ---
async function ovl(type) {
    if(current !== 'admin') {
        alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
        return;
    }
    
    const target = document.getElementById('adm_target').value.trim().toLowerCase();
    const val = parseFloat(document.getElementById('adm_val').value);
    
    try {
        if(type === 'money') {
            if(!target || isNaN(val)) {
                alert("–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ —Å—É–º–º—É!");
                return;
            }
            
            const userRef = db.ref('users/' + target);
            const snapshot = await userRef.once('value');
            
            if(!snapshot.exists()) {
                alert("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
            
            await userRef.child('balance').transaction(b => (b || 0) + val);
            await userRef.child('history').push(`üéÅ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† –í–´–î–ê–õ $${val.toLocaleString('ru')} | ${new Date().toLocaleTimeString('ru')}`);
            alert(`–í—ã–¥–∞–Ω–æ $${val} –∏–≥—Ä–æ–∫—É ${target}`);
            
        } else if(type === 'ban') {
            if(!target) {
                alert("–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω!");
                return;
            }
            
            const userRef = db.ref('users/' + target);
            const snapshot = await userRef.once('value');
            
            if(!snapshot.exists()) {
                alert("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
            
            await userRef.child('isBanned').set(true);
            alert(`–ò–≥—Ä–æ–∫ ${target} –∑–∞–±–∞–Ω–µ–Ω!`);
            
        } else if(type === 'pump') {
            await db.ref('market/crypto').transaction(p => {
                const newPrice = (p || 5000) * 2;
                return Math.min(newPrice, 1000000); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã
            });
            alert("–¶–µ–Ω–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã —É–¥–≤–æ–µ–Ω–∞!");
            
        } else if(type === 'dump') {
            await db.ref('market/crypto').transaction(p => {
                const newPrice = (p || 5000) * 0.5;
                return Math.max(newPrice, 100); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
            });
            alert("–¶–µ–Ω–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã —Å–Ω–∏–∂–µ–Ω–∞ –≤–¥–≤–æ–µ!");
            
        } else if(type === 'msg') {
            const msg = prompt("–í–≤–µ–¥–∏—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:");
            if(!msg || msg.trim() === '') return;
            
            const all = await db.ref('users').once('value');
            const timestamp = new Date().toLocaleTimeString('ru');
            
            let count = 0;
            for(let snapshot of all.val() ? Object.entries(all.val()) : []) {
                const [key, value] = snapshot;
                if(!value.isBanned) {
                    await db.ref('users/' + key + '/history').push(`üì¢ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†: ${msg} | ${timestamp}`);
                    count++;
                }
            }
            
            alert(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${count} –∏–≥—Ä–æ–∫–∞–º!`);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
        document.getElementById('adm_target').value = '';
        document.getElementById('adm_val').value = '';
        
    } catch(e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
    }
}

function logout() {
    if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?")) {
        location.reload();
    }
}

// --- –ì–†–ê–§–ò–ö–ò ---
const ctx = document.getElementById('stockChart').getContext('2d');
const myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            data: [],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            pointRadius: 3,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                display: false
            },
            y: {
                grid: {
                    color: '#334155',
                    drawBorder: false
                },
                ticks: {
                    color: '#94a3b8',
                    callback: function(value) {
                        return '$' + Math.floor(value);
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                titleColor: '#f8fafc',
                bodyColor: '#10b981',
                borderColor: '#334155',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                    label: function(context) {
                        return '$' + Math.floor(context.parsed.y).toLocaleString('ru');
                    }
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
});

function updateChartDisplay() {
    const s = document.getElementById('stockSelector').value;
    
    if(!chartData[s]) {
        chartData[s] = [];
    }
    
    chartData[s].push(prices[s]);
    
    if(chartData[s].length > 30) {
        chartData[s].shift();
    }
    
    myChart.data.labels = chartData[s].map((_, i) => i);
    myChart.data.datasets[0].data = chartData[s];
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø–æ —Ç—Ä–µ–Ω–¥—É
    const trend = chartData[s].length > 1 ? 
        (chartData[s][chartData[s].length - 1] > chartData[s][chartData[s].length - 2] ? 'up' : 'down') : 'neutral';
    
    myChart.data.datasets[0].borderColor = trend === 'up' ? '#10b981' : trend === 'down' ? '#ef4444' : '#3b82f6';
    myChart.data.datasets[0].backgroundColor = trend === 'up' ? 
        'rgba(16, 185, 129, 0.1)' : trend === 'down' ? 
        'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)';
    myChart.data.datasets[0].pointBackgroundColor = myChart.data.datasets[0].borderColor;
    
    myChart.update('none');
    updateStockInfo();
}

// –°–∏–º—É–ª—è—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –∞–∫—Ü–∏–π
setInterval(() => {
    ['mapple', 'mycrohard', 'colacoko'].forEach(stock => {
        db.ref('market/' + stock).transaction(p => {
            if(!p) p = stock === 'mapple' ? 100 : stock === 'mycrohard' ? 150 : 50;
            const change = (Math.random() > 0.48 ? 1.02 : 0.98);
            const newPrice = p * change;
            return Math.max(10, Math.min(newPrice, 10000)); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ü–µ–Ω
        });
    });
}, 8000);

// –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
setInterval(() => {
    if(current === 'admin') {
        db.ref('market/crypto').transaction(p => {
            if(!p) p = 5000;
            const volatility = Math.random();
            let change;
            
            if(volatility > 0.7) {
                change = 1.15; // –°–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç
            } else if(volatility > 0.45) {
                change = 1.03; // –°–ª–∞–±—ã–π —Ä–æ—Å—Ç
            } else if(volatility > 0.25) {
                change = 0.97; // –°–ª–∞–±–æ–µ –ø–∞–¥–µ–Ω–∏–µ
            } else {
                change = 0.85; // –°–∏–ª—å–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ
            }
            
            const newPrice = p * change;
            return Math.max(100, Math.min(newPrice, 1000000));
        });
    }
}, 7000);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
updateChartDisplay();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –≤—Ö–æ–¥–∞
document.getElementById('loginField').addEventListener('keypress', function(e) {
    if(e.key === 'Enter') {
        document.getElementById('passwordField').focus();
    }
});

document.getElementById('passwordField').addEventListener('keypress', function(e) {
    if(e.key === 'Enter') {
        loginUser();
    }
});

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–æ–≥–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
const lastLogin = localStorage.getItem('hehebank_last_login');
if(lastLogin) {
    document.getElementById('loginField').value = lastLogin;
    document.getElementById('passwordField').focus();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–Ω–∞ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ
const originalLogin = loginUser;
loginUser = async function() {
    const login = document.getElementById('loginField').value.trim().toLowerCase();
    await originalLogin();
    if(current) {
        localStorage.setItem('hehebank_last_login', login);
    }
};

console.log('%cüè¶ HEHEBANK v3.7 Enhanced Edition', 'color: #10b981; font-size: 20px; font-weight: bold;');
console.log('%c–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è:', 'color: #3b82f6; font-size: 14px;');
console.log('‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π UI/UX –¥–∏–∑–∞–π–Ω');
console.log('‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π');
console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏ –±–∏–∑–Ω–µ—Å–æ–≤');
console.log('‚úÖ –£–ª—É—á—à–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤');
console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö');
console.log('‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Firebase');
console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ü–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–∞–≥–æ–≤');
console.log('‚úÖ –£–ª—É—á—à–µ–Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏');
console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã');
console.log('‚úÖ –£–ª—É—á—à–µ–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
</script>
</body>
</html>
